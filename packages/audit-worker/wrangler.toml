name = "optiview-audit-worker"
main = "src/index.ts"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]

[[d1_databases]]
binding = "DB"
database_name = "optiview"
database_id = "17970af4-bbeb-4eea-9684-1464293b137b"

[[kv_namespaces]]
binding = "RULES"
id = "ede0baa1d4654ecb86a4d1faf7b5fd46"

[[kv_namespaces]]
binding = "PROMPT_CACHE"
id = "7119b238909b43afac31b53e359d0828"

[[kv_namespaces]]
binding = "AUTH_LOGS"
id = "12a06cdaa5054deeaec45309b4bd7d01"

[browser]
binding = "BROWSER"

[ai]
binding = "AI"

[vars]
BASE_URL = "https://api.optiview.ai"
PROXY_FETCH_ENDPOINT = "https://fetch.optiview.ai"
CITATIONS_MAX_CONCURRENCY = "3"
CITATIONS_THROTTLE_MS = "400"

# Auth configuration
APP_BASE_URL = "https://app.optiview.ai"
COOKIE_NAME = "ov_sess"
COOKIE_TTL_DAYS = "30"
MAGIC_TOKEN_TTL_MIN = "20"
MAGIC_REQUESTS_PER_HOUR = "5"

# Scorecard V2
SCORECARD_V2_ENABLED = "true"

# Phase Next - Production Configuration
PHASE_NEXT_ENABLED = "true"
PHASE_NEXT_SCORING = "true"
MVA_ENABLED = "true"
LEARNING_LOOP_ENABLED = "true"
VECTORIZE_ENABLED = "true"

[triggers]
crons = [
  "0 */6 * * *",  # Citations runs (every 6 hours)
  "0 14 * * 1",   # Weekly classifier benchmark
  "0 * * * *",    # Hourly health check
  "0 2 * * *",    # Daily MVA computation
  "0 3 * * *"     # Nightly recommendations (Learning Loop)
]
