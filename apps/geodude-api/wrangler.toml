name = "geodude-api"
main = "src/worker.js"
compatibility_date = "2025-08-01"

# Default/production values (used when no environment specified)
[vars]
PUBLIC_APP_URL = "https://optiview.ai"
PUBLIC_BASE_URL = "https://api.optiview.ai"
CSP_MODE = "production"
NODE_ENV = "production"
TEST_MODE = "false"
DEV_MAIL_ECHO = "false"
CACHE_OFF = "false"
METRICS_OFF = "false"

# Auth & limits (production defaults)
SESSION_TTL_HOURS = "720"
MAGIC_LINK_EXP_MIN = "15"
MAGIC_LINK_RPM_PER_IP = "10"
MAGIC_LINK_RPD_PER_EMAIL = "50"
INVITE_EXP_DAYS = "14"
ADMIN_RPM_PER_IP = "30"

# Ingest limits (production defaults)
INGEST_RATE_LIMIT_RPS = "10"
INGEST_RATE_LIMIT_BURST = "50"
RATE_LIMIT_RETRY_AFTER = "5"
CSV_EXPORT_RATE_LIMIT_RPS = "1"
RULES_REFRESH_TTL_SEC = "300"

# Email settings (production defaults)
EMAIL_SENDER_NAME = "Optiview"
EMAIL_FROM = "noreply@optiview.ai"

# AI-Lite tracking configuration
AI_LITE_SAMPLE_PCT = "2"
ENFORCE_AI_LITE = "false"
RETENTION_AI_DAYS = "365"
RETENTION_CRAWL_DAYS = "180"
RETENTION_BASELINE_SAMPLED_DAYS = "14"

# Database and KV bindings (shared across all environments)
[[d1_databases]]
binding = "OPTIVIEW_DB"
database_name = "optiview_db"
database_id = "975fb94d-9fac-4fd9-b8e2-41444f488334"

[[kv_namespaces]]
binding = "AI_FINGERPRINTS"
id = "571e1b9f739c4d0a9027b350cf091d20"
preview_id = "dev_ai_fingerprints"

# KV used for API response caching + project versioning
[[kv_namespaces]]
binding    = "CACHE"
id         = "351597e3c9e94f908fb256c50c8fe5c8"
preview_id = "a2853f2e1d7c498d800ee0013eeec3d3"

# KV used for rate limiting
[[kv_namespaces]]
binding = "RL"
id = "828d43c4d01a4da59e1eb457a118b6f1"
preview_id = "39fb95dccaf44f66a2a3e7384800fe08"

# KV used for metrics collection
[[kv_namespaces]]
binding = "METRICS"
id = "cfde18666cfc4904b64f63259f62e09f"
preview_id = "cfde18666cfc4904b64f63259f62e09f"

# Production environment (for specific production deployments)
[env.production]
name = "geodude-api"

[env.production.vars]
PUBLIC_APP_URL = "https://optiview.ai"
PUBLIC_BASE_URL = "https://api.optiview.ai"
CSP_MODE = "production"
NODE_ENV = "production"
TEST_MODE = "false"
DEV_MAIL_ECHO = "false"
CACHE_OFF = "false"

# Auth & limits (production defaults)
SESSION_TTL_HOURS = "720"
MAGIC_LINK_EXP_MIN = "15"
MAGIC_LINK_RPM_PER_IP = "10"
MAGIC_LINK_RPD_PER_EMAIL = "50"
INVITE_EXP_DAYS = "14"
ADMIN_RPM_PER_IP = "30"
ADMIN_TOKEN = "geodude-admin-2024"

# Ingest limits (production defaults)
INGEST_RATE_LIMIT_RPS = "10"
INGEST_RATE_LIMIT_BURST = "50"
RATE_LIMIT_RETRY_AFTER = "5"
CSV_EXPORT_RATE_LIMIT_RPS = "1"
RULES_REFRESH_TTL_SEC = "300"

# Email settings (production defaults)
EMAIL_SENDER_NAME = "Optiview"
EMAIL_FROM = "noreply@optiview.ai"

# AI-Lite tracking configuration
AI_LITE_SAMPLE_PCT = "2"
ENFORCE_AI_LITE = "false"
RETENTION_AI_DAYS = "365"
RETENTION_CRAWL_DAYS = "180"
RETENTION_BASELINE_SAMPLED_DAYS = "14"

# Production environment bindings
[[env.production.d1_databases]]
binding = "OPTIVIEW_DB"
database_name = "optiview_db"
database_id = "975fb94d-9fac-4fd9-b8e2-41444f488334"

[[env.production.kv_namespaces]]
binding = "AI_FINGERPRINTS"
id = "571e1b9f739c4d0a9027b350cf091d20"

# KV used for API response caching + project versioning
[[env.production.kv_namespaces]]
binding    = "CACHE"
id         = "351597e3c9e94f908fb256c50c8fe5c8"

# KV used for rate limiting
[[env.production.kv_namespaces]]
binding = "RL"
id = "828d43c4d01a4da59e1eb457a118b6f1"

# Staging environment
[env.staging.vars]
PUBLIC_APP_URL = "https://staging.optiview.ai"
PUBLIC_BASE_URL = "https://staging.api.optiview.ai"
CACHE_OFF = "false"

# Preview environment (for testing)
[env.preview.vars]
PUBLIC_APP_URL = "https://preview.optiview.ai"
PUBLIC_BASE_URL = "https://preview.api.optiview.ai"
CSP_MODE = "development"
NODE_ENV = "development"
TEST_MODE = "1"
DEV_MAIL_ECHO = "true"
CACHE_OFF = "false"
SESSION_TTL_HOURS = "720"
MAGIC_LINK_EXP_MIN = "15"
MAGIC_LINK_RPM_PER_IP = "10"
MAGIC_LINK_RPD_PER_EMAIL = "50"
INVITE_EXP_DAYS = "14"
ADMIN_RPM_PER_IP = "30"
INGEST_RATE_LIMIT_RPS = "10"
INGEST_RATE_LIMIT_BURST = "50"
RATE_LIMIT_RETRY_AFTER = "5"
CSV_EXPORT_RATE_LIMIT_RPS = "1"
RULES_REFRESH_TTL_SEC = "300"
EMAIL_SENDER_NAME = "Optiview"
EMAIL_FROM = "noreply@optiview.ai"

# Preview environment bindings
[[env.preview.d1_databases]]
binding = "OPTIVIEW_DB"
database_name = "optiview_db"
database_id = "975fb94d-9fac-4fd9-b8e2-41444f488334"

[[env.preview.kv_namespaces]]
binding = "AI_FINGERPRINTS"
id = "571e1b9f739c4d0a9027b350cf091d20"

[[env.preview.kv_namespaces]]
binding = "CACHE"
id = "351597e3c9e94f908fb256c50c8fe5c8"
preview_id = "a2853f2e1d7c498d800ee0013eeec3d3"

[[env.preview.kv_namespaces]]
binding = "RL"
id = "828d43c4d01a4da59e1eb457a118b6f1"

# Auth & limits (staging defaults)
SESSION_TTL_HOURS = "720"
MAGIC_LINK_EXP_MIN = "15"
MAGIC_LINK_RPM_PER_IP = "10"
MAGIC_LINK_RPD_PER_EMAIL = "50"
INVITE_EXP_DAYS = "14"
ADMIN_RPM_PER_IP = "30"

# Ingest limits (staging defaults)
INGEST_RATE_LIMIT_RPS = "10"
INGEST_RATE_LIMIT_BURST = "50"
RATE_LIMIT_RETRY_AFTER = "5"
CSV_EXPORT_RATE_LIMIT_RPS = "1"
RULES_REFRESH_TTL_SEC = "300"

# Staging environment bindings
[[env.staging.d1_databases]]
binding = "OPTIVIEW_DB"
database_name = "optiview_db"
database_id = "975fb94d-9fac-4fd9-b8e2-41444f488334"

[[env.staging.kv_namespaces]]
binding = "AI_FINGERPRINTS"
id = "571e1b9f739c4d0a9027b350cf091d20"

# KV used for API response caching + project versioning
[[env.staging.kv_namespaces]]
binding    = "CACHE"
id         = "351597e3c9e94f908fb256c50c8fe5c8"

# Test/Development environment
[env.test.vars]
PUBLIC_APP_URL = "http://localhost:3000"
PUBLIC_BASE_URL = "http://127.0.0.1:8787"
CSP_MODE = "development"
NODE_ENV = "development"
TEST_MODE = "1"
DEV_MAIL_ECHO = "true"
CACHE_OFF = "false"

# Auth & limits (test defaults - more permissive)
SESSION_TTL_HOURS = "24"
MAGIC_LINK_EXP_MIN = "60"
MAGIC_LINK_RPM_PER_IP = "50"
MAGIC_LINK_RPD_PER_EMAIL = "200"
INVITE_EXP_DAYS = "7"
ADMIN_RPM_PER_IP = "300"

# Ingest limits (test defaults - more permissive)
INGEST_RATE_LIMIT_RPS = "100"
INGEST_RATE_LIMIT_BURST = "500"
RATE_LIMIT_RETRY_AFTER = "1"
CSV_EXPORT_RATE_LIMIT_RPS = "20"
RULES_REFRESH_TTL_SEC = "30"

# Email settings (test defaults)
EMAIL_SENDER_NAME = "Optiview (Test)"
EMAIL_FROM = "test@optiview.ai"

# Test environment bindings
[[env.test.d1_databases]]
binding = "OPTIVIEW_DB"
database_name = "optiview_db"
database_id = "975fb94d-9fac-4fd9-b8e2-41444f488334"

[[env.test.kv_namespaces]]
binding = "AI_FINGERPRINTS"
id = "571e1b9f739c4d0a9027b350cf091d20"
preview_id = "dev_ai_fingerprints"

# KV used for API response caching + project versioning
[[env.test.kv_namespaces]]
binding    = "CACHE"
id         = "351597e3c9e94f908fb256c50c8fe5c8"
preview_id = "a2853f2e1d7c498d800ee0013eeec3d3"

# Dev environment (alias for test, used by deployment system)
[env.dev]
name = "geodude-api-dev"

[env.dev.vars]
PUBLIC_APP_URL = "https://dev.optiview.ai"
PUBLIC_BASE_URL = "https://api-dev.optiview.ai"
CSP_MODE = "development"
NODE_ENV = "development"
TEST_MODE = "1"
DEV_MAIL_ECHO = "true"
CACHE_OFF = "false"

# Auth & limits (dev defaults - more permissive)
SESSION_TTL_HOURS = "24"
MAGIC_LINK_EXP_MIN = "60"
MAGIC_LINK_RPM_PER_IP = "50"
MAGIC_LINK_RPD_PER_EMAIL = "200"
INVITE_EXP_DAYS = "7"
ADMIN_RPM_PER_IP = "300"

# Ingest limits (dev defaults - more permissive)
INGEST_RATE_LIMIT_RPS = "100"
INGEST_RATE_LIMIT_BURST = "500"
RATE_LIMIT_RETRY_AFTER = "1"
CSV_EXPORT_RATE_LIMIT_RPS = "20"
RULES_REFRESH_TTL_SEC = "30"

# Email settings (dev defaults)
EMAIL_SENDER_NAME = "Optiview (Dev)"
EMAIL_FROM = "dev@optiview.ai"

# Dev environment bindings
[[env.dev.d1_databases]]
binding = "OPTIVIEW_DB"
database_name = "optiview_db"
database_id = "975fb94d-9fac-4fd9-b8e2-41444f488334"

[[env.dev.kv_namespaces]]
binding = "AI_FINGERPRINTS"
id = "571e1b9f739c4d0a9027b350cf091d20"
preview_id = "dev_ai_fingerprints"

# KV used for API response caching + project versioning
[[env.dev.kv_namespaces]]
binding    = "CACHE"
id         = "351597e3c9e94f908fb256c50c8fe5c8"
preview_id = "a2853f2e1d7c498d800ee0013eeec3d3"

# Triggers (uncomment to enable after testing)
[triggers]
crons = [
  "*/5 * * * *",      # 5-minute metrics counters + health
  "0 * * * *",        # hourly rollups / stale session close
  "0 3 * * *"         # nightly maintenance/backfills
]
